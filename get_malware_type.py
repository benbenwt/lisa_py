import requests
import csv
import os
import re
def get_type(hash):
    url = 'https://api.threatbook.cn/v3/file/report'
    params = {
        'apikey': '41ae4fe9516f41ba86e11a796581e4bb6d1ae89830e84edcb213b4295f081fb3',
        'sandbox_type': 'win7_sp1_enx64_office2013',
        'sha256': hash
    }
    response = requests.get(url, params=params)
    request = dict(response.json())
    if "data" in request:
        data = request["data"]
        summary = data["summary"]
        tag = summary["tag"]
        if "x" in tag:
            x = tag["x"]
            print(x)
        return(x)
    else:return False

def begin(directory):
    row_list=[]
    headers=['sample','type']
    for root,sub_dirs,files in os.walk(directory):
        for file in files:
            hash=re.sub('.json','',file)
            type=get_type(hash)
            row=[]
            row.append(file)
            if type!=False: row.append(type)
            else: row.append('default')
            row_list.append(row)
    with open('data.csv','a',encoding='utf-8',newline='') as f:
        f_csv=csv.writer(f)
        f_csv.writerow(headers)
        f_csv.writerows(row_list)

if __name__ == '__main__':
    begin()


